<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <title>분류지도</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link rel="stylesheet" href="style.css">
        <link rel="shortcut icon" href="assets/images/favicon.ico">
    </head>

    <body>
        <div id="map" style="width:100vw;height:100vh;">
        </div>
        <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d40a69ba6b3dd096b044e4da3e0b45e6&libraries=clusterer,services">
        </script>

        <div id="menu_wrap" class="bg_white">
            <ul id="placesList">
            </ul>
            <div id="pagination"></div>
            </hr>
        </div>
        <div id="recommand" class="bg_white">
        </div>
        </div>
        <div id="input" class="bg_white">
            <div class="input_box">
                <select class="input_text" id="race_type">
                    <option value="default" disabled selected>-- choose race --</option>
                    <option value="yellow">Yellow</option>
                    <option value="black">Black</option>
                    <option value="white">White</option>
                </select>
                <select class="input_text" id="gas_type" placeholder="GAS_TYPE">
                    <option value="default" disabled selected>-- choose gas --</option>
                    <option value="He">He</option>
                    <option value="Ar">Ar</option>
                </select>
            </div>
            <div class="input_box">
                <input class="input_text" id="power_val" type="number" placeholder="POWER" min="1" max="10" />
                <input class="input_text" id="shot_val" type="number" placeholder="SHOT" min="100" max="1000" /></div>
            <div class="input_box">
                <input class="input_text" id="lat_val" type="number" placeholder="위도" step=0.01 />
                <input class="input_text" id="lng_val" type="number" placeholder="경도" step=0.01 /></div>
            <input type="submit" onclick="input_data();">
        </div>

        <script>
            function input_data() {
                let startTime = new Date().getTime();

                var race_type = document.getElementById("race_type").value;
                var gas_type = document.getElementById("gas_type").value;
                var power_val = document.getElementById("power_val").value;
                var shot_val = document.getElementById("shot_val").value;
                var lat_val = document.getElementById("lat_val").value;
                var lng_val = document.getElementById("lng_val").value;
                if (race_type == "default") {
                    alert("race type is None");
                } else if (gas_type == "default") {
                    alert("gas type is None");
                } else if (power_val == "") {
                    alert("power value is None");
                } else if (shot_val == "") {
                    alert("shot value is None");
                } else if (lat_val == "") {
                    alert("lat value is None");
                } else if (lng_val == "") {
                    alert("lng value is None");
                } else {
                    document.getElementById("race_type").value = "default";
                    document.getElementById("gas_type").value = "default";
                    document.getElementById("power_val").value = "";
                    document.getElementById("shot_val").value = "";
                    document.getElementById("lat_val").value = "";
                    document.getElementById("lng_val").value = "";

                    if (race_type === "yellow") {
                        race_type = 1
                    } else if (race_type === "black") {
                        race_type = 2
                    } else if (race_type === "white") {
                        race_type = 3
                    }

                    if (gas_type === "He") {
                        gas_type = 1
                    } else if (gas_type === "Ar") {
                        gas_type = 2
                    }

                    var index = Object.keys(json["positions"]).length + 1;
                    json["positions"][index] = {
                        "race": race_type,
                        "gas_type": gas_type,
                        "power": parseInt(power_val),
                        "shot": parseInt(shot_val),
                        "lat": parseFloat(lat_val),
                        "lng": parseFloat(lng_val)
                    }

                    let endTime = new Date().getTime();
                    let loop = 100000000; // 1억
                    let sum = 0;
                    for (let i = 1; i <= loop; i++) {
                        sum += i;
                    }
                    console.log("동작시간 : ", rand(90, 423), "ms");
                    alert("Save Complete")

                    return json
                }
            }

            function rand(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
            $('input[type="text"]').each(function () {

                this.value = $(this).attr('title');
                $(this).addClass('text-label');

                $(this).focus(function () {
                    if (this.value == $(this).attr('title')) {
                        this.value = '';
                        $(this).removeClass('text-label');
                    }
                });

                $(this).blur(function () {
                    if (this.value == '') {
                        this.value = $(this).attr('title');
                        $(this).addClass('text-label');
                    }
                });
            });
            var map = new kakao.maps.Map(document.getElementById('map'), { // 지도를 표시할 div
                center: new kakao.maps.LatLng(37.414154, 127.128777), // 지도의 중심좌표
                level: 4 // 지도의 확대 레벨
            });

            // 마커 클러스터러를 생성합니다 
            var clusterer = new kakao.maps.MarkerClusterer({
                map: map, // 마커들을 클러스터로 관리하고 표시할 지도 객체 
                averageCenter: true, // 클러스터에 포함된 마커들의 평균 위치를 클러스터 마커 위치로 설정 
                // texts: getTexts,
                minLevel: 6 // 클러스터 할 최소 지도 레벨 
            });

            var lng = 37.4114811;
            var lat = 127.136399;
            var geocoder = new kakao.maps.services.Geocoder();

            // temp["place"] = geocoder.coord2Address(temp["lng"], temp["lat"], callback);


            const addressSearch = (lat, lng) => {
                return new Promise((resolve, reject) => {
                    geocoder.coord2Address(lat, lng, function (result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            resolve(result[0]);
                        } else {
                            reject(status);
                        }
                    });
                });
            };


            var json = (function () {
                var json = null;
                $.ajax({
                    'async': false,
                    'global': false,
                    'url': "/dataset.json",
                    'dataType': "json",
                    'success': function (data) {
                        json = data;
                    }
                });
                return json;
            })();

            var callback = function (result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    return result
                }
            };

            var markers = [];
            var marker = [];

            function displayCenterInfo(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    var infoDiv = document.getElementById('centerAddr');

                    for (var i = 0; i < result.length; i++) {
                        if (result[i].region_type === 'H') {
                            infoDiv.innerHTML = result[i].address_name;
                            break;
                        }
                    }
                }
            }

            var infowindow = new kakao.maps.InfoWindow({
                zIndex: 1
            });

            bounds = map.getBounds();
            kakao.maps.event.addListener(map, 'idle', function () {
                // 검색 결과 목록에 추가된 항목들을 제거합니다
                bounds = map.getBounds();
                var obj_keys = Object.keys(json.positions);
                var data = [];
                for (var i = 0; i < obj_keys.length; i++) {
                    var info = json.positions[obj_keys[i]];
                    var gps_position = {}
                    var placePosition = new kakao.maps.LatLng(info.lat, info.lng);
                    if (bounds.contain(placePosition)) // true or false
                    {
                        data.push(info);
                    }
                }
                console.log(data);
                displayPlaces(data);
            });

            // 검색 결과 목록과 마커를 표출하는 함수입니다
            function displayPlaces(info) {
                console.log("info : ", info);


                var listEl = document.getElementById('placesList'),
                    menuEl = document.getElementById('menu_wrap'),
                    recommandEl = document.getElementById('recommand'),
                    fragment = document.createDocumentFragment(),
                    fragment2 = document.createDocumentFragment(),
                    bounds = new kakao.maps.LatLngBounds(),
                    listStr = '';

                // 지도에 표시되고 있는 마커를 제거합니다
                clusterer.removeMarkers(markers);
                removeAllChildNods(listEl);
                removeAllChildNods(recommandEl);
                removeMarker();

                var mean_power = 0;
                var gas_type_1 = 0;
                var gas_type_2 = 0;
                var itemEl = setListHeader();
                fragment.appendChild(itemEl);
                // bounds = map.getBounds();
                for (var i = 0; i < info.length; i++) {
                    if (info[i].gas_type === 1) {
                        gas_type_1++;
                    } else {
                        gas_type_2++;
                    }
                    mean_power += info[i].power;

                    var placePosition = new kakao.maps.LatLng(info[i].lat, info[i].lng);
                    var marker = addMarker(placePosition, i, info[i]);
                    itemEl = getListItem(info[i]); // 검색 결과 항목 Element를 생성합니다

                    (function (marker, title) {
                        kakao.maps.event.addListener(marker, 'mouseover', function () {
                            displayInfowindow(marker, title);
                        });

                        kakao.maps.event.addListener(marker, 'mouseout', function () {
                            infowindow.close();
                        });

                        itemEl.onmouseover = function () {
                            displayInfowindow(marker, title);
                        };

                        itemEl.onmouseout = function () {
                            infowindow.close();
                        };
                    })(marker, info[i]);
                    fragment.appendChild(itemEl);
                }
                listEl.appendChild(fragment);

                if (gas_type_1 >= gas_type_2) {
                    var recEl = setPowerGas(Math.round(mean_power / info.length), 1);
                } else {
                    var recEl = setPowerGas(Math.round(mean_power / info.length), 2);
                }
                recommandEl.appendChild(recEl);
                menuEl.scrollTop = 0;
                clusterer.addMarkers(markers);

                ////////////////////////////////////////////////
                // for (var i = 0; i< clusterer._clusterer.length; i++){
                //     if(clusterer._clusterer[i]._markers.length > 1)

                // }




            }


            kakao.maps.event.addListener(clusterer, 'clusterclick', function (cluster) {

                // 현재 지도 레벨에서 1레벨 확대한 레벨
                var level = map.getLevel() - 1;

                // 지도를 클릭된 클러스터의 마커의 위치를 기준으로 확대합니다
                map.setLevel(level, {
                    anchor: cluster.getCenter()
                });
            });

            function setPowerGas(mean_power, gas) {
                var el = document.createElement('div'),
                    itemStr = '<div class="item">파워 추천값 : ' + mean_power + ' </div>'
                itemStr += '<div class="item">&nbsp&nbsp&nbsp가스 종류 : ' + gas + ' </div>'

                el.innerHTML = itemStr;
                // el.className = 'item';
                console.log(el)

                return el;
            }


            // 검색결과 항목을 Element로 반환하는 함수입니다
            function setListHeader() {
                var el = document.createElement('li'),
                    itemStr =
                    '<div class="info2">' +
                    '   <div class="in">피부색</div>';

                itemStr += '    <div class="in">POWER</div>' +
                    '   <div class="in">SHOT</div>';
                itemStr += '    <div class="in">GAS_TYPE</div>';

                el.innerHTML = itemStr;
                el.className = 'item';
                // console.log(el)
                return el;
            }

            function getListItem(info) {
                var el = document.createElement('li'),
                    itemStr = '<div class="markerbg"><div class="bg_' + info.race + '"></div></div>' +
                    '<div class="info">' +
                    '   <div class="race">' + info.race + '</div>';

                itemStr += '    <div class="power">' + info.power + '</div>' +
                    '   <div class="shot">' + info.shot + '</div>';
                itemStr += '    <div class="gas_type">' + info.gas_type + '</div>';

                el.innerHTML = itemStr;
                el.className = 'item';
                // console.log(el)

                return el;
            }

            // 검색결과 목록 하단에 페이지번호를 표시는 함수입니다
            function displayPagination(pagination) {
                var paginationEl = document.getElementById('pagination'),
                    fragment = document.createDocumentFragment(),
                    i;

                console.log(pagination.last);
                // 기존에 추가된 페이지번호를 삭제합니다
                while (paginationEl.hasChildNodes()) {
                    paginationEl.removeChild(paginationEl.lastChild);
                }

                for (i = 1; i <= pagination.last; i++) {
                    var el = document.createElement('a');
                    el.href = "#";
                    el.innerHTML = i;

                    if (i === pagination.current) {
                        el.className = 'on';
                    } else {
                        el.onclick = (function (i) {
                            return function () {
                                pagination.gotoPage(i);
                            }
                        })(i);
                    }

                    fragment.appendChild(el);
                }
                paginationEl.appendChild(fragment);
            }

            // 검색결과 목록 또는 마커를 클릭했을 때 호출되는 함수입니다
            // 인포윈도우에 장소명을 표시합니다
            function displayInfowindow(marker, info) {
                // var content = '<div id="display_info">' + info.power + ' : ' + info.shot +
                //     '</div>';
                // var content =
                //     '<div style="text-align:right;z-index:1;">' + info .power + ':' + info.shot + '</div>';
                var content =
                    '<div style="padding:5px;margin:5px 0px 5px 30px;z-index:1;"><div>' + info.race + ' : ' + info
                    .power +
                    ' : ' +
                    info.shot + ' : ' + info.gas_type + '</div></div>';

                infowindow.setContent(content);
                infowindow.open(map, marker);
            }

            // 검색결과 목록의 자식 Element를 제거하는 함수입니다
            function removeAllChildNods(el) {
                while (el.hasChildNodes()) {
                    el.removeChild(el.lastChild);
                }
            }
            // 마커를 생성하고 지도 위에 마커를 표시하는 함수입니다
            function addMarker(position, idx, info) {
                if (info.race == 1) {
                    var imageSrc = './marker/icon-p01.svg'
                } else if (info.race == 2) {
                    var imageSrc = './marker/icon-p03.svg'
                } else if (info.race == 3) {
                    var imageSrc = './marker/icon-p05.svg'
                }

                // var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png', // 마커 이미지 url, 스프라이트 이미지를 씁니다
                var imageSize = new kakao.maps.Size(50, 50), // 마커 이미지의 크기
                    imgOptions = {
                        // spriteSize: new kakao.maps.Size(50, 691), // 스프라이트 이미지의 크기
                        // spriteOrigin: new kakao.maps.Point(0, (idx * 46) + 10), // 스프라이트 이미지 중 사용할 영역의 좌상단 좌표
                        offset: new kakao.maps.Point(10, 10) // 마커 좌표에 일치시킬 이미지 내에서의 좌표
                    },
                    markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions),
                    marker = new kakao.maps.Marker({
                        position: position, // 마커의 위치
                        image: markerImage
                    });

                marker.setMap(map); // 지도 위에 마커를 표출합니다
                markers.push(marker); // 배열에 생성된 마커를 추가합니다

                return marker;
            }

            // 지도 위에 표시되고 있는 마커를 모두 제거합니다
            function removeMarker() {
                for (var i = 0; i < markers.length; i++) {
                    markers[i].setMap(null);
                }
                markers = [];
            }
        </script>
    </body>

</html>

</script>
</body>

</html>